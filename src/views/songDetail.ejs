<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/detail.css">
    <link rel="stylesheet" href="/css/modal.css">
    <script src="/js/colorExtractor.js" defer></script>
    <script src="/js/utils/alert.js" defer></script>
    <script src="/js/utils/postFetch.js" defer></script>
    <script src="/js/songActions.js" defer></script>
</head>
<body>
    <%- include("partials/nav.ejs") %>
    <div class="detail-container">
        <h1><%= song.title || "Unknown Song" %></h1>
        
        <% if (coverArtUrl) { %>
        <div class="album-artwork">
            <img src="<%= coverArtUrl %>" alt="<%= song.title || 'Song' %> cover art">
        </div>
        <% } %>
        
        <div class="detail-section">
            <h2>Song Information</h2>
            <p><strong>Artist:</strong> 
                <% if (song["artist-credit"] && song["artist-credit"].length > 0) { %>
                    <% song["artist-credit"].forEach((ac, idx) => { %>
                        <% if (ac.artist && ac.artist.id) { %>
                            <a href="/artists/<%= ac.artist.id %>"><%= ac.name %></a><%= idx < song["artist-credit"].length - 1 ? ", " : "" %>
                        <% } else { %>
                            <%= ac.name %><%= idx < song["artist-credit"].length - 1 ? ", " : "" %>
                        <% } %>
                    <% }); %>
                <% } else { %>
                    N/A
                <% } %>
            </p>
            <% if (song.length) { %>
                <p><strong>Length:</strong> 
                    <%= Math.floor(song.length / 60000) %>:<%= String(Math.floor((song.length % 60000) / 1000)).padStart(2, "0") %>
                </p>
            <% } %>
            <% if (song.disambiguation) { %>
                <p><strong>Note:</strong> <%= song.disambiguation %></p>
            <% } %>
        </div>

        <% if (primaryAlbum) { %>
        <div class="detail-section">
            <h2>From Album</h2>
            <p><strong>Album:</strong> 
                <a href="/albums/<%= primaryAlbum.id %>"><%= primaryAlbum.title %></a>
            </p>
            <% if (primaryAlbum.date) { %>
                <p><strong>Release Date:</strong> <%= primaryAlbum.date %></p>
            <% } %>
            <% if (primaryAlbum.status) { %>
                <p><strong>Status:</strong> <%= primaryAlbum.status %></p>
            <% } %>
            <% if (primaryAlbum.country) { %>
                <p><strong>Country:</strong> <%= primaryAlbum.country %></p>
            <% } %>
        </div>
        <% } %>

        <% if (otherVersions && otherVersions.length > 1) { %>
        <div class="detail-section">
            <h2>All Versions/Recordings</h2>
            <p><em>This song has <%= otherVersions.length %> different recordings by the same artist:</em></p>
            <ul class="releases-list">
            <% otherVersions.forEach(version => { %>
                <li>
                    <a href="/songs/<%= version.id %>" <% if (version.id === song.id) { %>style="font-weight: bold;"<% } %>>
                        <%= version.title %>
                    </a>
                    <% if (version.length) { %>
                        - <%= Math.floor(version.length / 60000) %>:<%= String(Math.floor((version.length % 60000) / 1000)).padStart(2, "0") %>
                    <% } %>
                    <% if (version.albumTitle) { %>
                        - from 
                        <% if (version.albumId) { %>
                            <a href="/albums/<%= version.albumId %>"><%= version.albumTitle %></a>
                        <% } else { %>
                            <%= version.albumTitle %>
                        <% } %>
                    <% } %>
                    <% if (version.releaseDate) { %>
                        (<%= version.releaseDate %>)
                    <% } %>
                    <% if (version.disambiguation) { %>
                        <em> - <%= version.disambiguation %></em>
                    <% } %>
                    <% if (version.id === song.id) { %>
                        <strong>(Current)</strong>
                    <% } %>
                </li>
            <% }); %>
            </ul>
        </div>
        <% } %>

        <% if (song.releases && song.releases.length > 0) { %>
        <div class="detail-section">
            <h2>Appears On</h2>
            <ul class="releases-list">
            <% 
                // Filter out duplicate album titles, keep first occurrence
                const uniqueReleases = [];
                const seenTitles = new Set();
                
                for (const release of song.releases) {
                    const normalizedTitle = (release.title || "").toLowerCase().trim();
                    if (!seenTitles.has(normalizedTitle)) {
                        seenTitles.add(normalizedTitle);
                        uniqueReleases.push(release);
                    }
                }
                
                uniqueReleases.slice(0, 15).forEach(release => { 
            %>
                <li>
                    <a href="/albums/<%= release.id %>"><%= release.title %></a>
                    <% if (release.date) { %>
                        (<%= release.date %>)
                    <% } %>
                </li>
            <% }); %>
            </ul>
            <% if (uniqueReleases.length > 15) { %>
                <p><em>Showing 15 of <%= uniqueReleases.length %> unique releases</em></p>
            <% } %>
            <% if (song.releases.length > uniqueReleases.length) { %>
                <p><em>Total releases including duplicates: <%= song.releases.length %></em></p>
            <% } %>
        </div>
        <% } %>

        <div class="action-buttons">
            <% if (typeof user !== "undefined" && user) { %>
                <button 
                    id="track-song-btn" 
                    class="btn btn-track"
                    data-song-id="<%= song.id %>"
                    data-song-name="<%= song.title %>"
                    data-artist-name="<%= song['artist-credit'] && song['artist-credit'].length > 0 ? song['artist-credit'].map(ac => ac.name).join(', ') : 'Unknown Artist' %>"
                >
                    Track Song
                </button>
                <button 
                    id="complete-song-btn" 
                    class="btn btn-completed"
                    data-song-id="<%= song.id %>"
                    data-song-name="<%= song.title %>"
                    data-artist-name="<%= song['artist-credit'] && song['artist-credit'].length > 0 ? song['artist-credit'].map(ac => ac.name).join(', ') : 'Unknown Artist' %>"
                >
                    Mark as Completed
                </button>
            <% } else { %>
                <p class="login-prompt">
                    <a href="/login">Log in</a> to track or mark songs as completed
                </p>
            <% } %>
        </div>

        <a href="/songs/search" class="back-link">‚Üê Back to Search</a>
    </div>

    <%- include("partials/alert.ejs") %>
</body>
</html>
